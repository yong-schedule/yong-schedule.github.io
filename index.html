<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì†”ë¼ ìŠ¤ì¼€ì¤„</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#fafafa;}
header{padding:16px;font-size:24px;font-weight:900;text-align:center;}
#calendar{max-width:750px;margin:auto;padding:10px;}
#addBtn{
  position:fixed;right:16px;bottom:16px;
  padding:14px 18px;border-radius:999px;
  background:black;color:white;border:none;display:none;
}
.modal{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:#fff;padding:16px;border-radius:8px;
  max-width:90%;box-shadow:0 4px 12px rgba(0,0,0,.3);
  display:none;z-index:9999;
}
.modal.show{display:block;}
.modal input{width:100%;margin:6px 0;padding:6px;}
.modal button{margin-top:8px;padding:6px 12px;}
</style>
</head>

<body>
<header>ğŸ“… ì†”ë¼ ìŠ¤ì¼€ì¤„</header>

<div id="calendar"></div>
<button id="addBtn">ï¼‹ ì¼ì • ì¶”ê°€</button>

<!-- PIN ëª¨ë‹¬ -->
<div id="pinModal" class="modal show">
  <h3>ê´€ë¦¬ì PIN</h3>
  <input id="pinInput" type="password" maxlength="4" placeholder="4ìë¦¬ ìˆ«ì">
  <button id="pinBtn">í™•ì¸</button>
</div>

<!-- ì¼ì • ëª¨ë‹¬ -->
<div id="eventModal" class="modal">
  <h3>ì¼ì • ë“±ë¡ / ìˆ˜ì •</h3>
  <input id="eventTitle" placeholder="ì œëª©">
  <input id="eventDate" type="date">
  <input id="eventLink" placeholder="ë§í¬ (ì„ íƒ)">
  <button id="saveBtn">ì €ì¥</button>
  <button id="deleteBtn" style="background:#ef4444;color:white;">ì‚­ì œ</button>
</div>

<script>
/* ================= ì„¤ì • ================= */
const ADMIN_PIN = "1234"; // â˜… ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨
/* ======================================= */

firebase.initializeApp({
  apiKey: "AIzaSyD7PwhcOZpYMEm4znPSkCTkKM2ZJzlmX0k",
  projectId: "yong-schedule"
});

const db = firebase.firestore();

let unlocked = false;
let selectedEvent = null;

const pinModal = document.getElementById("pinModal");
const eventModal = document.getElementById("eventModal");
const addBtn = document.getElementById("addBtn");

/* PIN í™•ì¸ */
pinBtn.onclick = () => {
  if(pinInput.value === ADMIN_PIN){
    unlocked = true;
    pinModal.classList.remove("show");
    addBtn.style.display = "block";
  }else{
    alert("PIN í‹€ë¦¼");
  }
};

/* ì¼ì • ì¶”ê°€ */
addBtn.onclick = () => {
  if(!unlocked) return alert("PIN í•„ìš”");
  selectedEvent = null;
  eventTitle.value = "";
  eventDate.value = "";
  eventLink.value = "";
  deleteBtn.style.display = "none";
  eventModal.classList.add("show");
};

/* ìº˜ë¦°ë” ë¡œë“œ */
(async()=>{
  const snap = await db.collection("schedules").get();
  const events = snap.docs.map(doc => ({
    id: doc.id,
    title: doc.data().title,
    start: doc.data().start,
    link: doc.data().link || ""
  }));

  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: "ko",
    events,
    eventClick: info => {
      if(!unlocked){
        if(info.event.extendedProps.link){
          window.open(info.event.extendedProps.link, "_blank");
        }
        return;
      }
      selectedEvent = info.event;
      eventTitle.value = selectedEvent.title;
      eventDate.value = selectedEvent.startStr;
      eventLink.value = selectedEvent.extendedProps.link || "";
      deleteBtn.style.display = "inline-block";
      eventModal.classList.add("show");
    }
  });

  calendar.render();
})();

/* ì €ì¥ */
saveBtn.onclick = async () => {
  if(!unlocked) return alert("PIN í•„ìš”");
  if(!eventTitle.value || !eventDate.value) return alert("ì œëª©, ë‚ ì§œ í•„ìˆ˜");

  const data = {
    title: eventTitle.value,
    start: eventDate.value,
    link: eventLink.value
  };

  if(selectedEvent){
    await db.collection("schedules").doc(selectedEvent.id).update(data);
  }else{
    await db.collection("schedules").add(data);
  }
  location.reload();
};

/* ì‚­ì œ */
deleteBtn.onclick = async () => {
  if(!unlocked) return;
  if(selectedEvent && confirm("ì‚­ì œí• ê¹Œ?")){
    await db.collection("schedules").doc(selectedEvent.id).delete();
    location.reload();
  }
};
</script>
</body>
</html>
